<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.res.pla.mapper.UserPurchasedProductMapper">
  
 	<select id="selectAllUsableUppsById" resultType="com.res.pla.domain.UserPurchasedProductDTO" >  <!-- ID기준 사용가능한 모든 상품 -->
	        SELECT * FROM userpurchasedproduct WHERE id = #{id} and usable = true
	</select>
	
	 <select id="selectAllUsableUppsByIdPType" resultType="com.res.pla.domain.UserPurchasedProductDTO">         <!-- ID기준 모든 구매 상품 -->
	        SELECT * FROM userpurchasedproduct where id = #{id}
    </select>
        		    		
    <select id="selectAllUppsById" resultType="com.res.pla.domain.UserPurchasedProductDTO">         <!-- ID기준 모든 구매 상품 -->
	        SELECT * FROM userpurchasedproduct where id = #{id}
    </select>
   
    <select id="selectAfterStartDateUppsById" resultType="com.res.pla.domain.UserPurchasedProductDTO">         <!-- ID,날짜 기준 모든 구매 상품 -->
	        SELECT * FROM userpurchasedproduct where id = #{id} and startdate >= #{startDateTime} and refunded = false
    </select>
    
	<select id="selectAllUpps" resultType="com.res.pla.domain.UserPurchasedProductDTO">
	        SELECT * FROM userpurchasedproduct
	</select>
	
	<!-- =======================================================  -->
    
     <select id="selectUppByUppcode" resultType="com.res.pla.domain.UserPurchasedProductDTO" >      <!-- uppcode 기준 상품 1개 -->
	        SELECT * FROM userpurchasedproduct WHERE uppcode = #{uppcode}
    </select>
    
    <select id="selectInUsedTrueUpp" resultType="com.res.pla.domain.UserPurchasedProductDTO">
    		SELECT * FROM userpurchasedproduct WHERE id = #{id} AND inused = true
	</select>
	
    <select id="selectCalculatedTrueUpp" resultType="com.res.pla.domain.UserPurchasedProductDTO">
    		SELECT * FROM userpurchasedproduct WHERE id = #{id} AND calculated = true
	</select>
	
	 <select id="selectUsableOneUppByIdPType" resultType="com.res.pla.domain.UserPurchasedProductDTO">
    		SELECT * FROM userpurchasedproduct WHERE id = #{id} and usable = true
    		<choose>
        		<when test='pType == "df"'>
            		and ptype = #{pType}
        		</when>
        		<when test='pType == "df"'>
            		and ptype = #{pType}
        		</when>
        		<when test='pType == "df"'>
            		and ptype = #{pType}
        		</when>
        		<when test='pType == "df"'>
            		and (ptype = 'd' or ptype = 'f')
        		</when>
    		</choose>
    		order by purchasedate asc
    		limit 1
	</select>
    
    
    <!-- =======================================================  -->
    
    <update id="convertInUsed">
	        update userpurchasedproduct set inused = #{inused} where id = #{id} and uppcode = #{uppcode}
    </update>
    
    <update id="convertCalculated">
	        update userpurchasedproduct set calculated = #{calculated} where id = #{id} and uppcode = #{uppcode}
    </update>
    
    <update id="convertUsable">
	        update userpurchasedproduct set usable = #{usable} where id = #{id} and uppcode = #{uppcode}
    </update>
    
    <update id="realTimeCalculateUppTimePass">
	        update userpurchasedproduct 
	        set usedtime = usedtime + #{minute} , availabletime = availabletime - #{minute}
	        where id = #{id} and uppcode = #{uppcode}
    </update>
    
    <update id="realTimeCalculateUppDayPass">
	        update userpurchasedproduct 
	        set usedday = usedday + #{hour} , availableday = availableday - #{hour}
	        where id = #{id} and uppcode = #{uppcode}
    </update>
    
     <update id="clean" >
        truncate table userpurchasedproduct
    </update>
    
    
  
  </mapper>